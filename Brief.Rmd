---
title: "Brief"
output: 
  html_document: 
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, fig.width=10, fig.height=7)
options(width = 100)

library(tidyverse)



```

```{r, include=FALSE, cache = T, echo = F}
load("Results/Brief/out.rdata")

results <- bind_rows(out.i) %>%
  ungroup() %>%
  mutate(Est_Equal = ifelse(isEqual, "Equal", "Unequal"),
         Est_Random = ifelse(isRandom, "Random", "Fixed"),
         Gen = ifelse(Gen == "Y_EQ", "Equal", "Unequal"),
         Correct = (Est_Equal == Gen & Est_Random == "Random"),
         Correct = ifelse(Correct, T, NA),
         Parameter = factor(Parameter),
         Bs = factor(Bs),
         ICC = round(ICC, 2))

levels(results$Parameter) <- c("FE_Int", "FE_M", "FE_Mj", "FE_Xj", "FE_X", "RE_e", "RE_u")
levels(results$Bs) <- c("Weak L2", "Strong L2")


```

## Data Generation

### Fixed

  + Students
    * 3000
  + Schools
    * 100
  + Pretest
    * ~ N(0,1)
  + L1 Coefficients
    * Intercept = 0
    * Mobility = 1
    * Pretest = 1
  + Error
    * ~ N(0,1)
  

### Manipulated

  + p_{X,M}
    * 0
    * .25
    * .5
  + Mobility %
    * .1
    * .25
  + ICC
    * .15
    * .25
  + L2 Coefficients
    * Mobility = .5, 1
    * Pretest = .5, 1
  
  


## Results


### Collapse across conditions

There is some variation due to conditions but on average the different estimation methods do not seem to have much difference

```{r, cache = T, echo = F, fig.width=10, fig.height=7}
df_sum <- results %>% filter(stat == "Estimate")
# df_sum <- results %>% filter(stat == "Error")

df_sum %>%
  ggplot(aes(x = Gen, y = RPB, color = Est_Equal, linetype = Est_Random, fill = Correct)) +
  geom_boxplot() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = c(.05, -.05), linetype = "dashed") +
  labs(title = "RPB - All Conditions") +
  theme_bw() +
  scale_fill_brewer(type = "seq", palette = 1) +
  scale_color_brewer(type = "qual", palette = 2)



```

### RPB for each parameter across conditions

L1 fixed effects perform well with no apparent differences by weight and will be dropped for the remainder.

$\sigma$ is estimated well but left in. Notably this is the only parameter where correct weight specification consistantly outperforms

$\gamma_{M_j}$ displays substantial bias. 

```{r, cache = T, echo = F}
df_sum %>%
  ggplot(aes(x = Gen, y = RPB, color = Est_Equal, linetype = Est_Random, fill = Correct)) +
  geom_boxplot() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = c(.05, -.05), linetype = "dashed") +
  labs(title = "RPB - All Conditions by Parameter") +
  facet_wrap(~ Parameter, scales = "free_y") +
  theme_bw() +
  scale_fill_brewer(type = "seq", palette = 1) +
  scale_color_brewer(type = "qual", palette = 2)


```

### RPB for each parameter by $\rho_{X,M}$

Bizarre relationship between $\rho$ and $\gamma_{M_j}$ bias

```{r, cache = T, echo = F}

df_sum2 <- df_sum %>% filter(Parameter %in% c("FE_Mj", "FE_Xj", "RE_e", "RE_u"))

df_sum2 %>%
  ggplot(aes(x = Gen, y = RPB, color = Est_Equal, linetype = Est_Random, fill = Correct)) +
  geom_boxplot() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = c(.05, -.05), linetype = "dashed") +
  labs(title = "RPB - X_M Cor by Parameter") +
  facet_grid(Parameter ~ X_PS.cor) +
  # facet_grid(Parameter ~ X_PS.cor) +
  theme_bw() +
  scale_fill_brewer(type = "seq", palette = 1) +
  scale_color_brewer(type = "qual", palette = 2)


```

### RPB for each parameter by mobility %

$\gamma_{M_j}$seem biased with low mobility

Unequal weights result in biased $\gamma_{Y_j}$ and $\tau_{00}$ when true weights are equal

For some reason Fixed and Random Unequal weights seem to diverge from other models here for $\tau_{00}$ and $\gamma_{X_j}$

```{r, cache = T, echo = F}

df_sum2 %>%
  ggplot(aes(x = Gen, y = RPB, color = Est_Equal, linetype = Est_Random, fill = Correct)) +
  geom_boxplot() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = c(.05, -.05), linetype = "dashed") +
  labs(title = "RPB - %M by Parameter") +
  facet_wrap(Parameter ~ M.m , scales = "free_y", ncol = 4) +
  theme_bw() +
  scale_fill_brewer(type = "seq", palette = 1) +
  scale_color_brewer(type = "qual", palette = 2)

```

### RPB for each parameter by ICC

Larger ICC increases variability of $\gamma_{M_j}$ across other conditions, bias increased on average

Again Fixed and Random Unequal weights diverge  under equal weight generation condition

```{r, cache = T, echo = F}


df_sum2 %>%
  ggplot(aes(x = Gen, y = RPB, color = Est_Equal, linetype = Est_Random, fill = Correct)) +
  geom_boxplot() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = c(.05, -.05), linetype = "dashed") +
  labs(title = "RPB - ICC by Parameter") +
  facet_wrap(Parameter ~ ICC, scales = "free_y", ncol = 4) +
  theme_bw() +
  scale_fill_brewer(type = "seq", palette = 1) +
  scale_color_brewer(type = "qual", palette = 2)




```


### RPB for each parameter by L2 effects

Note: "Strong" $\gamma_{M_j} = \gamma_{X_j} = 1$; "Weak" $\gamma_{M_j} = \gamma_{X_j} = .5$

Again Fixed and Random Unequal weights diverg

```{r, cache = T, echo = F}
df_sum2 %>%
  ggplot(aes(x = Gen, y = RPB, color = Est_Equal, linetype = Est_Random, fill = Correct)) +
  geom_boxplot() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = c(.05, -.05), linetype = "dashed") +
  labs(title = "RPB - L2 effects by Parameter") +
  facet_wrap(Parameter ~ Bs, scales = "free_y", ncol = 4) +
  theme_bw() +
  scale_fill_brewer(type = "seq", palette = 1) +
  scale_color_brewer(type = "qual", palette = 2)
```

### $\gamma_{M_j}$

```{r, cache = T, echo = F}

df_sum %>%
  filter(Parameter == "FE_Mj") %>%
  ggplot(aes(x = Gen, y = RPB, color = Est_Equal, linetype = Est_Random, fill = Correct)) +
  geom_boxplot() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = c(.05, -.05), linetype = "dashed") +
  labs(title = "FE_Mj RPB - %M by cor(X,M)") +
  facet_grid(M.m ~ X_PS.cor) +
  theme_bw() +
  scale_fill_brewer(type = "seq", palette = 1) +
  scale_color_brewer(type = "qual", palette = 2)
```

```{r, cache = T, echo = F}

df_sum %>%
  filter(Parameter == "FE_Mj") %>%
  ggplot(aes(x = Gen, y = RPB, color = Est_Equal, linetype = Est_Random, fill = Correct)) +
  geom_boxplot() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = c(.05, -.05), linetype = "dashed") +
  labs(title = "FE_Mj RPB - %M by L2 Strength") +
  facet_grid(M.m ~ Bs) +
  theme_bw() +
  scale_fill_brewer(type = "seq", palette = 1) +
  scale_color_brewer(type = "qual", palette = 2)

```

## Results - RMSE

Note: limited interpretability due to low number of iterations

### Collapse across conditions

There is some variation due to conditions but on average the different estimation methods do not seem to have much difference

```{r, cache = T, echo = F, fig.width=10, fig.height=7}
df_sum <- results %>% filter(stat == "Estimate")
# df_sum <- results %>% filter(stat == "Error")

df_sum %>%
  ggplot(aes(x = Gen, y = RMSE, color = Est_Equal, linetype = Est_Random, fill = Correct)) +
  geom_boxplot() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = c(.05, -.05), linetype = "dashed") +
  labs(title = "RMSE - All Conditions") +
  theme_bw() +
  scale_fill_brewer(type = "seq", palette = 1) +
  scale_color_brewer(type = "qual", palette = 2)



```

### RMSE for each parameter across conditions

L1 fixed effects perform well with no apparent differences by weight and will be dropped for the remainder.

$\sigma$ is estimated well but left in. Notably this is the only parameter where correct weight specification consistantly outperforms

$\gamma_{M_j}$ displays substantial bias. 

```{r, cache = T, echo = F}
df_sum %>%
  ggplot(aes(x = Gen, y = RMSE, color = Est_Equal, linetype = Est_Random, fill = Correct)) +
  geom_boxplot() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = c(.05, -.05), linetype = "dashed") +
  labs(title = "RMSE - All Conditions by Parameter") +
  facet_wrap(~ Parameter, scales = "free_y") +
  theme_bw() +
  scale_fill_brewer(type = "seq", palette = 1) +
  scale_color_brewer(type = "qual", palette = 2)


```

### RMSE for each parameter by $\rho_{X,M}$

Bizarre relationship between $\rho$ and $\gamma_{M_j}$ bias

```{r, cache = T, echo = F}

df_sum2 <- df_sum %>% filter(Parameter %in% c("FE_Mj", "FE_Xj", "RE_e", "RE_u"))

df_sum2 %>%
  ggplot(aes(x = Gen, y = RMSE, color = Est_Equal, linetype = Est_Random, fill = Correct)) +
  geom_boxplot() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = c(.05, -.05), linetype = "dashed") +
  labs(title = "RMSE - X_M Cor by Parameter") +
  facet_grid(Parameter ~ X_PS.cor) +
  # facet_grid(Parameter ~ X_PS.cor) +
  theme_bw() +
  scale_fill_brewer(type = "seq", palette = 1) +
  scale_color_brewer(type = "qual", palette = 2)


```

### RMSE for each parameter by mobility %

$\gamma_{M_j}$seem biased with low mobility

Unequal weights result in biased $\gamma_{Y_j}$ and $\tau_{00}$ when true weights are equal

For some reason Fixed and Random Unequal weights seem to diverge from other models here for $\tau_{00}$ and $\gamma_{X_j}$

```{r, cache = T, echo = F}

df_sum2 %>%
  ggplot(aes(x = Gen, y = RMSE, color = Est_Equal, linetype = Est_Random, fill = Correct)) +
  geom_boxplot() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = c(.05, -.05), linetype = "dashed") +
  labs(title = "RMSE - %M by Parameter") +
  facet_wrap(Parameter ~ M.m , scales = "free_y", ncol = 4) +
  theme_bw() +
  scale_fill_brewer(type = "seq", palette = 1) +
  scale_color_brewer(type = "qual", palette = 2)

```

### RMSE for each parameter by ICC

Larger ICC increases variability of $\gamma_{M_j}$ across other conditions, bias increased on average

Again Fixed and Random Unequal weights diverge  under equal weight generation condition

```{r, cache = T, echo = F}


df_sum2 %>%
  ggplot(aes(x = Gen, y = RMSE, color = Est_Equal, linetype = Est_Random, fill = Correct)) +
  geom_boxplot() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = c(.05, -.05), linetype = "dashed") +
  labs(title = "RMSE - ICC by Parameter") +
  facet_wrap(Parameter ~ ICC, scales = "free_y", ncol = 4) +
  theme_bw() +
  scale_fill_brewer(type = "seq", palette = 1) +
  scale_color_brewer(type = "qual", palette = 2)




```


### RMSE for each parameter by L2 effects

Note: "Strong" $\gamma_{M_j} = \gamma_{X_j} = 1$; "Weak" $\gamma_{M_j} = \gamma_{X_j} = .5$

Again Fixed and Random Unequal weights diverg

```{r, cache = T, echo = F}
df_sum2 %>%
  ggplot(aes(x = Gen, y = RMSE, color = Est_Equal, linetype = Est_Random, fill = Correct)) +
  geom_boxplot() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = c(.05, -.05), linetype = "dashed") +
  labs(title = "RMSE - L2 effects by Parameter") +
  facet_wrap(Parameter ~ Bs, scales = "free_y", ncol = 4) +
  theme_bw() +
  scale_fill_brewer(type = "seq", palette = 1) +
  scale_color_brewer(type = "qual", palette = 2)
```

### $\gamma_{M_j}$

```{r, cache = T, echo = F}

df_sum %>%
  filter(Parameter == "FE_Mj") %>%
  ggplot(aes(x = Gen, y = RMSE, color = Est_Equal, linetype = Est_Random, fill = Correct)) +
  geom_boxplot() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = c(.05, -.05), linetype = "dashed") +
  labs(title = "FE_Mj RMSE - %M by cor(X,M)") +
  facet_grid(M.m ~ X_PS.cor) +
  theme_bw() +
  scale_fill_brewer(type = "seq", palette = 1) +
  scale_color_brewer(type = "qual", palette = 2)
```

```{r, cache = T, echo = F}

df_sum %>%
  filter(Parameter == "FE_Mj") %>%
  ggplot(aes(x = Gen, y = RMSE, color = Est_Equal, linetype = Est_Random, fill = Correct)) +
  geom_boxplot() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = c(.05, -.05), linetype = "dashed") +
  labs(title = "FE_Mj RMSE - %M by L2 Strength") +
  facet_grid(M.m ~ Bs) +
  theme_bw() +
  scale_fill_brewer(type = "seq", palette = 1) +
  scale_color_brewer(type = "qual", palette = 2)

```